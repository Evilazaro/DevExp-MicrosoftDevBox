{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.30.23.60470",
      "templateHash": "16706033305002611670"
    }
  },
  "parameters": {
    "solutionName": {
      "type": "string",
      "metadata": {
        "description": "Solution Name"
      }
    }
  },
  "variables": {
    "vnetName": "[format('{0}-vnet', parameters('solutionName'))]",
    "logAnalyticsWorkspaceName": "[format('{0}-logAnalytics', parameters('solutionName'))]",
    "managementResourceGroupName": "[format('{0}-Management-rg', parameters('solutionName'))]",
    "tags": {
      "division": "PlatformEngineeringTeam-DX",
      "enrironment": "Production",
      "offering": "DevBox-as-a-Service",
      "solution": "[parameters('solutionName')]",
      "landingZone": "Network"
    },
    "securityRules": [
      {
        "name": "Allow-SSH",
        "properties": {
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "22",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Allow",
          "priority": 100,
          "direction": "Inbound"
        }
      },
      {
        "name": "Allow-HTTP",
        "properties": {
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "80",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Allow",
          "priority": 110,
          "direction": "Inbound"
        }
      },
      {
        "name": "Allow-HTTPS",
        "properties": {
          "protocol": "Tcp",
          "sourcePortRange": "*",
          "destinationPortRange": "443",
          "sourceAddressPrefix": "*",
          "destinationAddressPrefix": "*",
          "access": "Allow",
          "priority": 120,
          "direction": "Inbound"
        }
      }
    ],
    "virtualNetworkConnectionName": "[format('{0}-networkConnection', parameters('solutionName'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "virtualNetwork",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetworkName": {
            "value": "[variables('vnetName')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.23.60470",
              "templateHash": "13018269539233032240"
            }
          },
          "parameters": {
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "The location of the virtual network"
              }
            },
            "addressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/16",
              "metadata": {
                "description": "The address prefix of the virtual network"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "The tags of the virtual network"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2024-01-01",
              "name": "[parameters('virtualNetworkName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('addressPrefix')]"
                  ]
                }
              },
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Deploy a virtual network to Azure"
              }
            }
          ],
          "outputs": {
            "virtualNetworkId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the virtual network"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
            },
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "The name of the virtual network"
              },
              "value": "[parameters('virtualNetworkName')]"
            },
            "subnets": {
              "type": "array",
              "metadata": {
                "description": "Subnets of the virtual network"
              },
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName')), '2024-01-01').subnets]"
            }
          }
        }
      },
      "metadata": {
        "description": "Deploy the virtual network"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networkSecurityGroup",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "nsgName": {
            "value": "[variables('vnetName')]"
          },
          "securityRules": {
            "value": "[variables('securityRules')]"
          },
          "tags": {
            "value": "[variables('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.23.60470",
              "templateHash": "15090315394016385778"
            }
          },
          "parameters": {
            "nsgName": {
              "type": "string",
              "defaultValue": "myNsg",
              "metadata": {
                "description": "The name of the network security group"
              }
            },
            "securityRules": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The security rules of the network security group"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "The tags of the network security group"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2024-01-01",
              "name": "[parameters('nsgName')]",
              "location": "[resourceGroup().location]",
              "tags": "[parameters('tags')]",
              "properties": {
                "securityRules": "[parameters('securityRules')]"
              },
              "metadata": {
                "description": "Deploy a network security group to Azure"
              }
            }
          ],
          "outputs": {
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the network security group"
              },
              "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('nsgName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
      ],
      "metadata": {
        "description": "Deploy the network security group"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "subnet",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetworkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2022-09-01').outputs.virtualNetworkName.value]"
          },
          "nsgId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup'), '2022-09-01').outputs.nsgId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.23.60470",
              "templateHash": "6666930691102220311"
            }
          },
          "parameters": {
            "virtualNetworkName": {
              "type": "string",
              "metadata": {
                "description": "Create a subnet in a virtual network"
              }
            },
            "subnetAddressPrefix": {
              "type": "string",
              "defaultValue": "10.0.0.0/24",
              "metadata": {
                "description": "The address prefix of the subnet"
              }
            },
            "nsgId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the network security group"
              }
            }
          },
          "variables": {
            "subnetName": "[format('{0}-subnet', parameters('virtualNetworkName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2024-01-01",
              "name": "[format('{0}/{1}', parameters('virtualNetworkName'), variables('subnetName'))]",
              "properties": {
                "addressPrefix": "[parameters('subnetAddressPrefix')]",
                "networkSecurityGroup": {
                  "id": "[parameters('nsgId')]"
                }
              },
              "metadata": {
                "description": "Deploy a subnet to a virtual network"
              }
            }
          ],
          "outputs": {
            "subnetId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the subnet"
              },
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), variables('subnetName'))]"
            },
            "subnetName": {
              "type": "string",
              "metadata": {
                "description": "The name of the subnet"
              },
              "value": "[variables('subnetName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'networkSecurityGroup')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
      ],
      "metadata": {
        "description": "Deploy the subnet"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "networkConnection",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "virtualNetwortkName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'virtualNetwork'), '2022-09-01').outputs.virtualNetworkName.value]"
          },
          "tags": {
            "value": "[variables('tags')]"
          },
          "virtualNetworkConnectionName": {
            "value": "[variables('virtualNetworkConnectionName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.23.60470",
              "templateHash": "6898418791242390299"
            }
          },
          "parameters": {
            "virtualNetworkConnectionName": {
              "type": "string",
              "metadata": {
                "description": "Network Connection Name"
              }
            },
            "virtualNetwortkName": {
              "type": "string",
              "metadata": {
                "description": "Subnet ID"
              }
            },
            "tags": {
              "type": "object",
              "metadata": {
                "description": "Tags for the Network Connection"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DevCenter/networkConnections",
              "apiVersion": "2024-08-01-preview",
              "name": "[parameters('virtualNetworkConnectionName')]",
              "location": "[resourceGroup().location]",
              "tags": "[parameters('tags')]",
              "properties": {
                "domainJoinType": "AzureADJoin",
                "subnetId": "[reference(resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetwortkName')), '2024-01-01').subnets[0].id]"
              },
              "metadata": {
                "description": "Deploy a network connection to Azure"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'subnet')]",
        "[resourceId('Microsoft.Resources/deployments', 'virtualNetwork')]"
      ],
      "metadata": {
        "description": "Deploy the network connection"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "diagnosticSettings",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "diagnosticSettingsName": {
            "value": "default"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[variables('logAnalyticsWorkspaceName')]"
          },
          "logAnalyticsResourceGroupName": {
            "value": "[variables('managementResourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.30.23.60470",
              "templateHash": "17982478932769723150"
            }
          },
          "parameters": {
            "diagnosticSettingsName": {
              "type": "string",
              "defaultValue": "default",
              "metadata": {
                "description": "Diagnostic Settings Name"
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Worskpace Name"
              }
            },
            "logAnalyticsResourceGroupName": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Resource Group Name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "name": "[parameters('diagnosticSettingsName')]",
              "properties": {
                "logs": [
                  {
                    "category": "allLogs",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "enabled": true
                  }
                ],
                "workspaceId": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('logAnalyticsResourceGroupName')), 'Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              }
            }
          ]
        }
      },
      "metadata": {
        "description": "Deploy the diagnostic settings for the network"
      }
    }
  ]
}